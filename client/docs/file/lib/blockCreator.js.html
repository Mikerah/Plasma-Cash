<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/blockCreator.js | backend</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="backend"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="backend"><meta property="twitter:description" content="backend"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/PatriciaMerkle.js~Merkle.html">Merkle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/SparseMerkle.js~Merkle.html">Merkle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/blockCreator.js~BlockCreator.html">BlockCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/txPool.js~TXPool.html">TXPool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/txTestController.js~TestTransactionsCreator.html">TestTransactionsCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createDeposits">createDeposits</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validate">validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateRequestBySchema">validateRequestBySchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-blockCreator">blockCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-client">client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-txPool">txPool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-testTransactionsCreator">testTransactionsCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-parseM">parseM</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts">contracts</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/contracts/plasma.js~ContractHandler.html">ContractHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-contractHandler">contractHandler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#handlers">handlers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processDepositEvent">processDepositEvent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBlock">getBlock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createDepositTransaction">createDepositTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSignedTransaction">createSignedTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllUtxos">getAllUtxos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllUtxosWithKeys">getAllUtxosWithKeys</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUTXO">getUTXO</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#model">model</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/model/block.js~Block.html">Block</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/model/tx.js~PlasmaTransaction.html">PlasmaTransaction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/blockCreator.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import config from &apos;config&apos;;
import { logger } from &apos;lib/logger&apos;;
import txPool from &apos;lib/txPool&apos;;
import redis from &apos;lib/redis&apos;;
import contractHandler from &apos;lib/contracts/plasma&apos;;
import depositEventHandler from &apos;lib/handlers/DepositEventHandler&apos;;
import web3 from &apos;lib/web3&apos;;
import Block from &apos;lib/model/block&apos;;
import ethUtil from &apos;ethereumjs-util&apos;; 

class BlockCreator {
  constructor (options = {}) {
    this.options = options || {};
  }

  start() {
    this.initBlockPeriodicalCreation();
    this.startBlockSubmittingToParent();
    this.blockEventsCheck(null);
  }

  async initBlockPeriodicalCreation() {
    let poollen = await txPool.length();
    logger.info(&apos;Creating New Block - len &apos;, poollen, &apos;tx, &apos;, this.options.minTransactionsInBlock);

    if (this.options.minTransactionsInBlock &amp;&amp; poollen &gt;= this.options.minTransactionsInBlock) {
      await txPool.createNewBlock();
    }
    
    setTimeout(this.initBlockPeriodicalCreation.bind(this), config.blockPeriod)
    return true;
  }

  async startBlockSubmittingToParent() {
    try {
      let lastBlockInDatabase = await redis.getAsync(&apos;lastBlockNumber&apos;);
      lastBlockInDatabase = lastBlockInDatabase ? parseInt(lastBlockInDatabase) : 0;
      let lastSubmittedBlock = await redis.getAsync(&apos;lastBlockSubmitted&apos;);
      lastSubmittedBlock = lastSubmittedBlock ? parseInt(lastSubmittedBlock): 0;

      logger.info(&apos;LastBlockInDatabase, LastSubmittedBlock&apos;, lastBlockInDatabase, lastSubmittedBlock)
      
      if (lastBlockInDatabase &gt; lastSubmittedBlock) {
        let currentBlockInParent = await contractHandler.contract.methods.current_blk().call();
        if (currentBlockInParent != lastSubmittedBlock) {
          if (currentBlockInParent &gt; lastSubmittedBlock) 
            await redis.setAsync(&apos;lastBlockSubmitted&apos;, currentBlockInParent);
        } else {
          lastSubmittedBlock += config.contractblockStep;
          this.startBlockSubmit(lastSubmittedBlock);
        }
      }
    } catch(error) {
      logger.error(&apos;Submiting block error &apos;, error);
    }
    setTimeout(this.startBlockSubmittingToParent.bind(this), 30000);
  }
  
  async blockEventsCheck(lastCheckedBlock) {
    let lastBlock;
    if (lastCheckedBlock == null) {
      lastCheckedBlock = await redis.getAsync(&apos;lastEventProcessed&apos;);
      lastCheckedBlock = lastCheckedBlock ? parseInt(lastCheckedBlock) : 0;
    }
    try {
      lastBlock = await web3.eth.getBlockNumber();
      if (lastBlock &gt; lastCheckedBlock) {
        lastCheckedBlock++;

        logger.info(&apos;Process Block for Deposit Events - &apos;, lastBlock);

        const depositEventsInBlock = await contractHandler.contract.getPastEvents(&quot;DepositAdded&quot;, {
          fromBlock: lastCheckedBlock,
          toBlock: lastBlock
        });

        if (depositEventsInBlock.length &gt; 0) {
          for (let i = 0, length = depositEventsInBlock.length; i &lt; length; ++i)
            depositEventHandler(depositEventsInBlock[i]);
        }
        redis.setAsync(&apos;lastEventProcessed&apos;, lastBlock);
      }
    } catch(error) {
      logger.error(&quot;blockEventsCheck error &quot; + error);
      lastBlock = lastCheckedBlock;
    }
    setTimeout(() =&gt; this.blockEventsCheck(lastBlock), 5000);
  }

  async startBlockSubmit(blockNumber) {
    let blockKey = &apos;block&apos; + blockNumber.toString(10);
    let block = new Block(await redis.getAsync(Buffer.from(blockKey)));
    let blockMerkleRootHash = ethUtil.addHexPrefix(block.merkleRootHash.toString(&apos;hex&apos;));
   
    await web3.eth.personal.unlockAccount(config.plasmaOperatorAddress, config.plasmaOperatorPassword, 60);

    logger.info(&apos;Block submit #&apos;, blockNumber, blockMerkleRootHash);
    let gas = await contractHandler.contract.methods.submitBlock(blockMerkleRootHash, blockNumber).estimateGas({from: config.plasmaOperatorAddress});
    await contractHandler.contract.methods.submitBlock(blockMerkleRootHash, blockNumber).send({from: config.plasmaOperatorAddress, gas});
    logger.info(&apos;Submitted block #&apos;, blockNumber);

    redis.setAsync(&apos;lastBlockSubmitted&apos;, blockNumber);
  }
}

const blockCreator = new BlockCreator({
  minTransactionsInBlock: 5
});

export default blockCreator;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>

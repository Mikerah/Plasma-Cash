<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/txTestController.js | backend</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="backend"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="backend"><meta property="twitter:description" content="backend"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/PatriciaMerkle.js~Merkle.html">Merkle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/SparseMerkle.js~Merkle.html">Merkle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/blockCreator.js~BlockCreator.html">BlockCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/txPool.js~TXPool.html">TXPool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/txTestController.js~TestTransactionsCreator.html">TestTransactionsCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createDeposits">createDeposits</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validate">validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateRequestBySchema">validateRequestBySchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-blockCreator">blockCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-client">client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-txPool">txPool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-testTransactionsCreator">testTransactionsCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-parseM">parseM</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts">contracts</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/contracts/plasma.js~ContractHandler.html">ContractHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-contractHandler">contractHandler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#handlers">handlers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processDepositEvent">processDepositEvent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBlock">getBlock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createDepositTransaction">createDepositTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSignedTransaction">createSignedTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllUtxos">getAllUtxos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllUtxosWithKeys">getAllUtxosWithKeys</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUTXO">getUTXO</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#model">model</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/model/block.js~Block.html">Block</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/model/tx.js~PlasmaTransaction.html">PlasmaTransaction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/txTestController.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">
import { createSignedTransaction } from &apos;lib/helpers/tx&apos;;
import web3 from &apos;lib/web3&apos;;
import Promise from &apos;bluebird&apos;;
import config from &quot;config&quot;;
const ethUtil = require(&apos;ethereumjs-util&apos;); 
import RLP from &apos;rlp&apos;;
import txPool from &apos;lib/txPool&apos;;
import { getAllUtxosWithKeys } from &apos;lib/helpers/tx&apos;;


let accounts = [
  &apos;0x2BF64b0ebd7Ba3E20C54Ec9F439c53e87E9d0a70&apos;.toLowerCase(),
  &apos;0x11A618DE3ADe9B85Cd811BF45af03bAd481842Ed&apos;.toLowerCase(), 
  &apos;0xa5fe0deda5e1a0fcc34b02b5be6857e30c9023fe&apos;.toLowerCase(),
  &apos;0x9345a4d4a43815c613cf9e9db1920b9c9eeb8dc7&apos;.toLowerCase(),
  &apos;0x220cD6eBB62F9aD170C9bf7984F22A3afc023E7d&apos;.toLowerCase()
];

let prkeys = {};
prkeys[accounts[0]] = Buffer.from(&apos;de3385a80c15c12bc7dd7800f5d383229569269016e6501a2714a3a77885007a&apos;, &apos;hex&apos;);
prkeys[accounts[1]] = Buffer.from(&apos;86737ebcbdfda1c14a069782b585fed4fb15847206ca179ea8988161ddbb8ad6&apos;, &apos;hex&apos;);
prkeys[accounts[2]] = Buffer.from(&apos;06889a2975e9db1487e33ea76f82a034660de671d0594e9470d4f7be4b6feaf1&apos;, &apos;hex&apos;);
prkeys[accounts[3]] = Buffer.from(&apos;723851e910975a4ff44b2ec28b719c42ae3c9ea33c187abaa018292a02d5e9a9&apos;, &apos;hex&apos;);
prkeys[accounts[4]] = Buffer.from(&apos;25d9bb435e7d96e692054668add7f8b857567b2075b9e2f6b0659c4b6c7ed31c&apos;, &apos;hex&apos;);

class TestTransactionsCreator {
    constructor () {
        this.ready = false;
        this.utxos = [];
        this.alltransactions = [];
        
        this.nextAddressGen = getNextAddress(accounts);
        this.nextAddressGen.next();
        this.blockCreatePromise = Promise.resolve(true);
    }

    async createTransactionsFromUTXO() {
      this.utxos = await getAllUtxosWithKeys();
      this.alltransactions = [];

      for (let i in this.utxos) {
          let utxo = this.utxos[i];
          let blockNumber = parseInt(i.split(&apos;_&apos;)[1]);

          try {
            let txData = {
              prev_hash:  utxo.getHash().toString(&apos;hex&apos;),
              prev_block: blockNumber,
              token_id: utxo.token_id.toString(),
              new_owner: this.nextAddressGen.next(utxo.new_owner).value
            };
            let txDataForRlp = [ethUtil.addHexPrefix(txData.prev_hash), txData.prev_block, ethUtil.toBuffer(txData.token_id), txData.new_owner];
            let txRlpEncoded = ethUtil.hashPersonalMessage(ethUtil.sha3(RLP.encode(txDataForRlp)));
            
            if (utxo.new_owner instanceof Buffer)
              utxo.new_owner = ethUtil.addHexPrefix(utxo.new_owner.toString(&apos;hex&apos;)).toLowerCase();

            let signature = ethUtil.ecsign(txRlpEncoded, prkeys[utxo.new_owner]);
            
            txData.signature = ethUtil.toRpcSig(signature.v, signature.r, signature.s).toString(&quot;hex&quot;);
            let createdTx = createSignedTransaction(txData);
            this.alltransactions.push(createdTx);
          } catch (e) {
            console.log(e);
          }
      }

      console.log(&apos;TXcount - &apos;, this.alltransactions.length);
  }

    async init() {
        try {
            for (let address of accounts) {
              await web3.eth.personal.unlockAccount(address, config.plasmaOperatorPassword, 0);
              console.log(&apos;Unlock account: &apos;, address);
            }
            await this.createTransactionsFromUTXO();
            setInterval(()=&gt; this.createTransactionsFromUTXO(), 60000);
        }
        catch (err) {
            console.log(&apos;error&apos;, err);
            this.ready = false;
        }
    }

    async createNewTransactions(req) {
      return await txPool.addTransaction(this.alltransactions[parseInt(req.headers[&apos;test&apos;])]);
    }

}
    function* getNextAddress(addresses) {
        let currentAddress = 0;
        let addressToExclude;
        while(true) {
          if (!addresses[++currentAddress]) {
              currentAddress = 0;
          }
          if (addressToExclude &amp;&amp; addresses[currentAddress] == addressToExclude) {
              if (!addresses[++currentAddress]) {
                  currentAddress = 0;
                 if (addresses[currentAddress] == addressToExclude) {
                  currentAddress++;
                 }
              }
          }
          addressToExclude = yield addresses[currentAddress];
        }
      }

const testTransactionsCreator = new TestTransactionsCreator;

//if (config.isDevelopment)
  testTransactionsCreator.init();

export default testTransactionsCreator;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
